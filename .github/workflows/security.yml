name: ğŸ”’ Security Scanning

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly security scan on Mondays at 2 AM
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  security-scan:
    name: ğŸ›¡ï¸ Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ”§ Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety semgrep
          pip install -r requirements.txt

      - name: ğŸ” Run Bandit Security Scan
        run: |
          echo "ğŸ” Running Bandit security scan..."
          bandit -r src/ pages/ main.py -f json -o bandit-results.json || true
          bandit -r src/ pages/ main.py -f txt

      - name: ğŸ”’ Check for Known Vulnerabilities
        run: |
          echo "ğŸ”’ Running Safety vulnerability check..."
          safety check --json > safety-results.json || echo "âš ï¸ Safety check completed with warnings"
          safety check

      - name: ğŸ§ª Run Semgrep Security Analysis
        run: |
          semgrep --config=auto --json --output=semgrep-results.json .
          semgrep --config=auto .

      - name: ğŸ³ Build Docker Image for Scanning
        id: docker-build
        run: |
          echo "ğŸ³ Building Docker image for security scanning..."
          if docker build -t ai-trading-security:latest .; then
            echo "âœ… Docker build successful"
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Docker build failed, will skip Docker security scan"
            echo "build_success=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: ğŸ” Scan Docker Image with Trivy
        if: steps.docker-build.outputs.build_success == 'true'
        run: |
          echo "ğŸ” Running Trivy Docker security scan..."
          
          # Scan the Docker image and generate SARIF
          docker run --rm -v "$(pwd)":/workspace \
            aquasec/trivy:latest image \
            --format sarif \
            --output /workspace/trivy-docker-results.sarif \
            ai-trading-security:latest || echo "âš ï¸ Trivy scan completed with warnings"
          
          echo "âœ… Docker security scan completed"
        continue-on-error: true

      - name: ğŸ”§ Create Fallback SARIF File
        if: steps.docker-build.outputs.build_success != 'true'
        run: |
          echo "ğŸ”§ Creating fallback SARIF file (Docker build failed)..."
          cat > trivy-docker-results.sarif << 'EOF'
          {
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "trivy",
                    "version": "fallback",
                    "informationUri": "https://github.com/aquasecurity/trivy"
                  }
                },
                "results": [
                  {
                    "ruleId": "docker-build-failed",
                    "level": "note",
                    "message": {
                      "text": "Docker build failed - Docker security scan skipped"
                    },
                    "locations": [
                      {
                        "physicalLocation": {
                          "artifactLocation": {
                            "uri": "Dockerfile"
                          },
                          "region": {
                            "startLine": 1,
                            "startColumn": 1
                          }
                        }
                      }
                    ]
                  }
                ]
              }
            ]
          }
          EOF
          echo "âœ… Fallback SARIF file created"

      - name: ï¿½ Verify SARIF File Exists
        run: |
          if [ -f "trivy-docker-results.sarif" ]; then
            echo "âœ… SARIF file exists ($(wc -c < trivy-docker-results.sarif) bytes)"
            echo "ğŸ“‹ File content preview:"
            head -n 10 trivy-docker-results.sarif
          else
            echo "âŒ SARIF file missing - creating minimal fallback"
            echo '{"$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json", "version": "2.1.0", "runs": [{"tool": {"driver": {"name": "trivy"}}, "results": []}]}' > trivy-docker-results.sarif
          fi

      - name: ï¿½ğŸ“Š Upload Security Scan Results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && github.event_name != 'pull_request' && hashFiles('trivy-docker-results.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: |
            trivy-docker-results.sarif

      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            bandit-results.json
            safety-results.json
            semgrep-results.json
            trivy-docker-results.sarif

      - name: ğŸš¨ Security Notifications  
        if: failure()
        uses: 8398a7/action-slack@v3
        continue-on-error: true
        with:
          status: failure
          text: |
            ğŸš¨ **Security Scan Failed!**
            ğŸ” Repository: ${{ github.repository }}
            ğŸ“ Commit: ${{ github.sha }}
            ğŸ”— View Results: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  dependency-check:
    name: ğŸ“¦ Dependency Vulnerability Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'AI Trading Platform'
          path: '.'
          format: 'ALL'

      - name: ğŸ“¤ Upload Dependency Check Results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-results
          path: reports/

  secret-scan:
    name: ğŸ” Secret Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  code-analysis:
    name: ğŸ”¬ Static Code Analysis
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.repository_owner == github.actor
    
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”¬ Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"
