name: ğŸ”’ Security Scanning

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly security scan on Mondays at 2 AM
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  security-scan:
    name: ğŸ›¡ï¸ Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ”§ Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety semgrep
          pip install -r requirements.txt

      - name: ğŸ” Run Bandit Security Scan
        run: |
          bandit -r . -f json -o bandit-results.json
          bandit -r . -f txt

      - name: ğŸ”’ Check for Known Vulnerabilities
        run: |
          safety check --json --output safety-results.json
          safety check

      - name: ğŸ§ª Run Semgrep Security Analysis
        run: |
          semgrep --config=auto --json --output=semgrep-results.json .
          semgrep --config=auto .

      - name: ğŸ³ Build Docker Image for Scanning
        run: |
          docker build -t ai-trading-security:latest .

      - name: ğŸ” Scan Docker Image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'ai-trading-security:latest'
          format: 'sarif'
          output: 'trivy-docker-results.sarif'

      - name: ğŸ“Š Upload Security Scan Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: |
            trivy-docker-results.sarif

      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-scan-results
          path: |
            bandit-results.json
            safety-results.json
            semgrep-results.json
            trivy-docker-results.sarif

      - name: ğŸš¨ Security Notifications
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            ğŸš¨ **Security Scan Failed!**
            ğŸ” Repository: ${{ github.repository }}
            ğŸ“ Commit: ${{ github.sha }}
            ğŸ”— View Results: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  dependency-check:
    name: ğŸ“¦ Dependency Vulnerability Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'AI Trading Platform'
          path: '.'
          format: 'ALL'

      - name: ğŸ“¤ Upload Dependency Check Results
        uses: actions/upload-artifact@v3
        with:
          name: dependency-check-results
          path: reports/

  secret-scan:
    name: ğŸ” Secret Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  code-analysis:
    name: ğŸ”¬ Static Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”¬ Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python

      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
