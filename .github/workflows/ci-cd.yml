name: ğŸš€ AI Trading Platform CI/CD

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

permissions:
  actions: read
  contents: read
  security-events: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # ============================================================================
  # Code Quality & Security Checks
  # ============================================================================
  code-quality:
    name: ğŸ” Code Quality & Security
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ”§ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort bandit safety
          pip install -r requirements.txt

      - name: ğŸ¨ Check code formatting with Black
        run: |
          black --check --diff --line-length=88 .

      - name: ğŸ“Š Check import sorting with isort
        run: |
          isort --check-only --diff --profile black .

      - name: ï¿½ Run Bandit Security Scan
        run: |
          echo "ğŸ” Running Bandit security scan..."
          bandit -r src/ pages/ main.py -f json -o bandit-report.json || true
          bandit -r src/ pages/ main.py -f txt

      - name: ğŸ”’ Check for known security vulnerabilities
        run: |
          echo "ğŸ”’ Running Safety vulnerability check..."
          safety check --output json > safety-report.json || echo "âš ï¸ Safety check completed with warnings"
          safety check

      - name: ğŸ“¤ Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # ============================================================================
  # Docker Build & Security Scan
  # ============================================================================
  docker-build:
    name: ğŸ³ Docker Build & Scan
    runs-on: ubuntu-latest
    needs: [code-quality]
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: ai-trading-platform:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ” Run Trivy vulnerability scanner
        run: |
          echo "ğŸ” Running Trivy vulnerability scanner..."
          
          # Create proper SARIF template with required version property
          cat > trivy-results.sarif << 'EOF'
          {
            "version": "2.1.0",
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "Trivy",
                    "version": "latest",
                    "informationUri": "https://trivy.dev"
                  }
                },
                "results": []
              }
            ]
          }
          EOF
          
          # Run Trivy scan with proper SARIF format
          docker run --rm -v "$(pwd)":/workspace \
            aquasec/trivy:latest image \
            --format sarif \
            --output /workspace/trivy-results.sarif \
            ai-trading-platform:${{ github.sha }} || {
              echo "âš ï¸ Trivy scan completed with warnings or errors"
              echo "Using fallback SARIF template"
            }
          
          echo "âœ… Trivy scan output generated"

      - name: ğŸ“¤ Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && github.event_name != 'pull_request'
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  # ============================================================================
  # Deploy to Staging
  # ============================================================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'
    environment: staging
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸš„ Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: ğŸš€ Deploy to Railway Staging
        run: |
          railway link ${{ secrets.RAILWAY_STAGING_PROJECT_ID }}
          railway up --service ${{ secrets.RAILWAY_STAGING_SERVICE }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: ğŸ” Health Check Staging
        run: |
          sleep 30
          curl -f ${{ secrets.STAGING_URL }}/_stcore/health || exit 1
          echo "âœ… Staging deployment successful!"

      - name: ğŸ’¬ Staging Deployment Notification
        uses: 8398a7/action-slack@v3
        if: always()
        continue-on-error: true
        with:
          status: ${{ job.status }}
          text: |
            ğŸš€ Staging Deployment: ${{ job.status }}
            ğŸ“ Commit: ${{ github.event.head_commit.message }}
            ğŸ”— URL: ${{ secrets.STAGING_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ============================================================================
  # Deploy to Production
  # ============================================================================
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event.inputs.environment == 'production'
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸš„ Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: ğŸŒŸ Deploy to Railway Production
        run: |
          echo "ğŸš‚ Linking to Railway project..."
          railway link ${{ secrets.RAILWAY_PROJECT_ID }} || railway link --environment production
          echo "ğŸš€ Deploying to Railway..."
          railway up --service ${{ secrets.RAILWAY_SERVICE }} || railway up
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: ğŸ” Health Check Production
        run: |
          sleep 30
          curl -f https://aitrading-production.up.railway.app/_stcore/health || exit 1
          echo "âœ… Production deployment successful!"

      - name: ğŸ·ï¸ Create Release Tag
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          TAG="v$(date +'%Y.%m.%d')-$(echo ${{ github.sha }} | cut -c1-7)"
          git tag $TAG
          git push origin $TAG

      - name: ğŸ“¢ Production Deployment Notification
        uses: 8398a7/action-slack@v3
        if: always()
        continue-on-error: true
        with:
          status: ${{ job.status }}
          text: |
            ğŸŒŸ Production Deployment: ${{ job.status }}
            ğŸ“ Commit: ${{ github.event.head_commit.message }}
            ğŸ”— URL: https://aitrading-production.up.railway.app
            ğŸ·ï¸ Version: v$(date +'%Y.%m.%d')-$(echo ${{ github.sha }} | cut -c1-7)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ============================================================================
  # Performance & Load Testing
  # ============================================================================
  performance-test:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Install k6
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: âš¡ Run performance tests
        run: |
          k6 run tests/performance/load-test.js
        env:
          TEST_URL: ${{ secrets.STAGING_URL }}

      - name: ğŸ“Š Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: performance-results.json
